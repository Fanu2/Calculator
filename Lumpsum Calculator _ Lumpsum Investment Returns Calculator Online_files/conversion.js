!function(h,e,t,i){t.modules({"webengage/conversion":[function(e,i,s){"use strict";var a,f=t.require("webengage/util"),d=t.require("webengage/dom"),v=t.require("webengage/events"),c=t.require("webengage/rules"),r=t.require("webengage/state"),w=t.require("webengage/weq");a=location.host.match(/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/)?location.host:-1===location.host.indexOf(".")?location.host.split(":")[0]:location.host.split(":")[0].match(/[-\w]+(\.(?:[-\w]+\.xn--[-\w]+|[-\w]{3,}|[-\w]+\.[-\w]{2}))?$/i)[0];var l=null,p={setGoalsCookie:function(e){return e=e||{},d.cookie.setCookie("_we_wk_gls_ss_",f.compress.compressToBase64(f.stringify(e)),"","/",a,""),e},getGoalsCookie:function(){var e=f.getCookie("_we_wk_gls_ss_",!0)||null;return e&&("{"!==e.charAt(0)&&(e=f.compress.decompressFromBase64(e)),e=f.parseJSON(e)),e},findNonHashedIds:function(e,i){var s=[];if(e&&e[i]&&f.isArray(e[i]))for(var n=0;n<e[i].length;n++)e[i][n]&&e[i][n].indexOf("#")<0&&(s.push(e[i][n]),e[i][n]+="#");return s},getActiveIds:function(e,i){var s=[],n=r.getServerTimestamp()||null;if(e)for(var t=0;t<e.length;t++){var o=e[t].startTimestamp,a=e[t].endTimestamp;n&&(a&&a<n||o&&n<o)||s.push(e[t][i])}return s},getAllActiveNotifications:function(){return p.getActiveIds(l.notificationRuleList,"notificationEncId")},getAllActiveSurveys:function(){return p.getActiveIds(l.surveyRuleList,"surveyEncId")},idsToRetain:function(e,i){var s=[],n=i?i.join():"";if(e&&n){for(var t=0;t<e.length;t++)0<=n.indexOf(e[t])&&s.push(e[t]);return s}},logConversion:function(e,i){if(e){var s=p.getGoalsCookie(),n={};if(s&&s[e]){var t=p.getAllActiveNotifications(),o=p.getAllActiveSurveys();if(0<t.length){var a=p.idsToRetain(f.isArray(s[e].snids)&&0<s[e].snids.length?s[e].snids:null,t),d=p.idsToRetain(f.isArray(s[e].cnids)&&0<s[e].cnids.length?s[e].cnids:null,t),c=p.idsToRetain(f.isArray(s[e].canids)&&0<s[e].canids.length?s[e].canids:null,t),r=p.idsToRetain(p.findNonHashedIds(s[e],"anids"),t);a&&0<a.length&&(n.snids=a),c&&0<c.length&&(n.ncnids=c),d&&0<d.length&&(n.cnids=d),r&&0<r.length&&(n.anids=r)}if(0<o.length){var l=p.idsToRetain(f.isArray(s[e].ssids)&&0<s[e].ssids.length?s[e].ssids:null,o),g=p.idsToRetain(f.isArray(s[e].tsids)&&0<s[e].tsids.length?s[e].tsids:null,o),u=p.idsToRetain(p.findNonHashedIds(s[e],"asids"),o);l&&0<l.length&&(n.ssids=l),g&&0<g.length&&(n.tsids=g),u&&0<u.length&&(n.asids=u)}}f.isEmptyObject(w.get("webengage.customData"))||f.copy(n,w.get("webengage.customData")||{}),f.isEmptyObject(w.get("webengage.notification.customData"))||f.copy(n,w.get("webengage.notification.customData")||{}),f.isEmptyObject(w.get("webengage.survey.customData"))||f.copy(n,w.get("webengage.survey.customData")||{}),f.isEmptyObject(i)||f.copy(n,i,!0),v.publish("event.system","goal_accomplish",n,{goal_id:e}),s&&s[e]&&(delete s[e].snids,delete s[e].cnids,delete s[e].canids,delete s[e].ssids,delete s[e].tsids,p.setGoalsCookie(s))}}};function g(o){var a=o.id;function n(e,i){var s=i.notificationId||i.id;if(s&&0<=o.nIds.join().indexOf(s)){var n=p.getGoalsCookie()||{};switch(n[a]=n[a]||{},e){case"open":i.isNotificationClickable?(n[a].canids=n[a].canids||[],n[a].canids.join().indexOf(i.notificationId)<0&&n[a].canids.push(i.notificationId)):(n[a].snids=n[a].snids||[],n[a].snids.join().indexOf(i.notificationId)<0&&n[a].snids.push(i.notificationId)),p.setGoalsCookie(n);break;case"click":n[a].cnids=n[a].cnids||[],n[a].cnids.join().indexOf(i.notificationId)<0&&n[a].cnids.push(i.notificationId),p.setGoalsCookie(n);break;case"view":case"abs_view":var t="view"===e?"intc":"aintc";n[a][t]||(n[a][t]=1),"abs_view"===e&&(n[a].anids=n[a].anids||[],f.indexOfArray(n[a].anids,s)<0&&f.indexOfArray(n[a].anids,s+"#")<0&&n[a].anids.push(s)),p.setGoalsCookie(n)}}}t.notification.onOpen(function(e){n("open",e)}),t.notification.onClick(function(e){n("click",e)}),v.subscribe("event.system",function(e,i,s){"notification_view"===e?n("view",{notificationId:s.id}):"notification_abs_view"===e&&n("abs_view",{notificationId:s.id})})}function u(o){var a=o.id;function n(e,i){var s=i.surveyId||i.id;if(s&&0<=o.sIds.join().indexOf(s)){var n=p.getGoalsCookie()||{};switch(n[a]=n[a]||{},e){case"open":n[a].ssids=n[a].ssids||[],n[a].ssids.join().indexOf(s)<0&&n[a].ssids.push(s),p.setGoalsCookie(n);break;case"submit":case"complete":n[a].tsids=n[a].tsids||[],n[a].tsids.join().indexOf(s)<0&&n[a].tsids.push(s),p.setGoalsCookie(n),o.type&&"SURVEY_COMPLETION"===o.type&&"complete"===e&&p.logConversion(a);break;case"view":case"abs_view":var t="view"===e?"intc":"aintc";n[a][t]||(n[a][t]=1),"abs_view"===e&&(n[a].asids=n[a].asids||[],f.indexOfArray(n[a].asids,s)<0&&f.indexOfArray(n[a].asids,s+"#")<0&&n[a].asids.push(s)),p.setGoalsCookie(n)}}}t.survey.onOpen(function(e){n("open",e)}),t.survey.onSubmit(function(e){n("submit",e)}),t.survey.onComplete(function(e){n("complete",e)}),v.subscribe("event.system",function(e,i,s){"survey_view"===e?n("view",{surveyId:s.id}):"survey_abs_view"===e&&n("abs_view",{surveyId:s.id})})}var n={push:function(e,i){if(e&&l&&l.goals&&l.goals.length)for(var s,n=0;n<l.goals.length;n++)(s=l.goals[n]).id&&s.id===e&&p.logConversion(e,i)},init:function(e){e&&f.isArray(e.goals)&&0<e.goals.length&&(l=e,v.subscribe("event.system",function(e){"visitor_new_session"===e&&d.cookie.setCookie("_we_wk_gls_ss_","",-1,"/",a,"")}),t.onReady(function(){var e=r.getSession();e.tld&&(a=e.tld),1===e.pvc&&d.cookie.setCookie("_we_wk_gls_ss_","",-1,"/",a,"");for(var i=0;i<l.goals.length;i++){var s=l.goals[i],n=s.value,t=s.type;if(!t||"WEB_RULE"===t){var o=w.get("webengage.ruleData")||w.get("webengage.goals.ruleData")||{};w.get("webengage.is_csp")&&h.webengage_fs_rulesMap&&h.webengage_fs_rulesMap[s.id]&&h.webengage_fs_rulesMap[s.id].value&&(n=h.webengage_fs_rulesMap[s.id].value),c.execute("",n,o)&&p.logConversion(s.id)}f.isArray(s.nIds)&&0<s.nIds.length&&g(s),f.isArray(s.sIds)&&0<s.sIds.length&&u(s)}}))}};i.exports=n},{}]},{},[])}(window,document,webengage);